# 서울 지하철 광고 영업 시스템 - 기능 명세서

**프로젝트명:** 위마켓 (WeMarket)
**버전:** 1.0
**작성일:** 2026-01-12
**문서 유형:** 기능 명세서 (Functional Specification)

---

## 목차

1. [시스템 구성](#1-시스템-구성)
2. [화면 명세](#2-화면-명세)
3. [기능 상세 명세](#3-기능-상세-명세)
4. [API 명세](#4-api-명세)
5. [데이터 흐름](#5-데이터-흐름)
6. [비즈니스 규칙](#6-비즈니스-규칙)

---

## 1. 시스템 구성

### 1.1 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                        클라이언트 (브라우저)                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │  랜딩 페이지  │  │  인증 페이지  │  │  대시보드   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Next.js 16 서버                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    미들웨어 (middleware.ts)                │   │
│  │              - 세션 검증 - 라우트 보호 - 리다이렉트          │   │
│  └──────────────────────────────────────────────────────────┘   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ /api/localdata│ │/api/send-proposal│ │/api/station-info│     │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                              │
          ┌───────────────────┼───────────────────┐
          ▼                   ▼                   ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│    Supabase     │  │  LocalData API  │  │    KRIC API     │
│  - PostgreSQL   │  │  (사업자 정보)   │  │  (역사 정보)    │
│  - Auth         │  └─────────────────┘  └─────────────────┘
│  - Storage      │           │
│  - RLS          │           ▼
└─────────────────┘  ┌─────────────────┐
                     │   Resend API    │
                     │   (이메일 발송)  │
                     └─────────────────┘
```

### 1.2 페이지 구조

```
/ (랜딩 페이지)
├── /auth (인증 페이지)
│   └── /callback (OAuth 콜백)
├── /lead-manager (메인 대시보드) ★ 인증 필요
├── /floor-plans (역사 도면)
└── /contact (문의 페이지)
```

### 1.3 컴포넌트 구조

```
src/
├── app/
│   ├── lead-manager/
│   │   ├── page.tsx                 # 메인 대시보드
│   │   ├── types.ts                 # 타입 정의
│   │   ├── constants.ts             # 상수 (지하철역 데이터)
│   │   ├── utils.ts                 # 유틸리티 함수
│   │   ├── api.ts                   # API 호출 함수
│   │   ├── *-service.ts             # 서비스 레이어 (7개)
│   │   └── components/
│   │       ├── GridView.tsx         # 그리드 뷰
│   │       ├── ListView.tsx         # 리스트 뷰
│   │       ├── MapView.tsx          # 지도 뷰
│   │       ├── StatsBar.tsx         # 통계 바
│   │       ├── SettingsModal.tsx    # 설정 모달
│   │       ├── BackupButton.tsx     # 백업 버튼
│   │       ├── crm/                 # CRM 컴포넌트
│   │       ├── inventory/           # 인벤토리 컴포넌트
│   │       └── schedule/            # 스케줄 컴포넌트
│   └── floor-plans/
│       ├── page.tsx                 # 도면 페이지
│       ├── types.ts                 # 도면 타입
│       ├── *-service.ts             # 도면 서비스
│       └── components/              # 도면 컴포넌트
├── lib/
│   ├── supabase/
│   │   ├── client.ts                # 브라우저 클라이언트
│   │   └── server.ts                # 서버 클라이언트
│   └── kric-api.ts                  # KRIC API 래퍼
└── components/
    ├── Providers.tsx                # 전역 프로바이더
    └── ThemeToggle.tsx              # 테마 토글
```

---

## 2. 화면 명세

### 2.1 랜딩 페이지 (/)

#### 2.1.1 화면 구성

```
┌────────────────────────────────────────────────────────────────┐
│ [헤더]                                                         │
│  위마켓 로고        [로그인] [회원가입]                          │
├────────────────────────────────────────────────────────────────┤
│ [히어로 섹션]                                                   │
│                                                                │
│      서울 지하철 광고의 새로운 패러다임                           │
│      ━━━━━━━━━━━━━━━━━━━━━━━━━━                                │
│                                                                │
│      [1][2][3][4][5][6][7][8][9]  ← 노선 배지                  │
│                                                                │
│      [AI자동추천]  [데모 보기]                                   │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│ [기능 카드 섹션] (6개)                                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                       │
│  │ 리드 관리  │ │ 위치 분석 │ │ 통화 기록 │                       │
│  └──────────┘ └──────────┘ └──────────┘                       │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                       │
│  │ 영업 현황 │ │ 데이터 보안│ │ 실시간 동기화│                    │
│  └──────────┘ └──────────┘ └──────────┘                       │
├────────────────────────────────────────────────────────────────┤
│ [워크플로우 섹션]                                               │
│   ① 리드 발굴  →  ② 제안서 발송  →  ③ 계약 체결                  │
├────────────────────────────────────────────────────────────────┤
│ [통계 섹션]                                                     │
│   서울교통공사    |    300+ 역    |    실시간 동기화             │
├────────────────────────────────────────────────────────────────┤
│ [푸터]                                                         │
└────────────────────────────────────────────────────────────────┘
```

#### 2.1.2 UI 요소

| 요소 | 타입 | 동작 |
|------|------|------|
| 로그인 버튼 | Button | /auth 페이지로 이동 |
| 회원가입 버튼 | Button | /auth 페이지로 이동 |
| AI자동추천 버튼 | Button (Primary) | /contact 페이지로 이동 |
| 데모 보기 버튼 | Button (Secondary) | 데모 모달 표시 |
| 노선 배지 | Badge (1~9) | 호버 시 노선 정보 툴팁 |

---

### 2.2 인증 페이지 (/auth)

#### 2.2.1 화면 구성

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│                    ┌─────────────────────┐                     │
│                    │                     │                     │
│                    │    위마켓 로고       │                     │
│                    │                     │                     │
│                    │  [로그인] [회원가입]  │  ← 탭 전환           │
│                    │                     │                     │
│                    │  ┌───────────────┐  │                     │
│                    │  │ 이메일         │  │                     │
│                    │  └───────────────┘  │                     │
│                    │  ┌───────────────┐  │                     │
│                    │  │ 비밀번호       │  │                     │
│                    │  └───────────────┘  │                     │
│                    │                     │                     │
│                    │  [    로그인    ]   │                     │
│                    │                     │                     │
│                    │  ─── 또는 ───       │                     │
│                    │                     │                     │
│                    │  [Google 로그인]    │                     │
│                    │                     │                     │
│                    └─────────────────────┘                     │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

#### 2.2.2 로그인 탭

| 필드 | 타입 | 검증 |
|------|------|------|
| 이메일 | Input (email) | 이메일 형식 필수 |
| 비밀번호 | Input (password) | 최소 6자 |

#### 2.2.3 회원가입 탭

| 필드 | 타입 | 검증 |
|------|------|------|
| 이메일 | Input (email) | 이메일 형식 필수, 중복 검사 |
| 비밀번호 | Input (password) | 최소 6자 |
| 비밀번호 확인 | Input (password) | 비밀번호와 일치 |
| 조직 선택 | Radio | 새 조직 생성 / 기존 조직 가입 |
| 조직명 | Input (text) | 새 조직 생성 시 필수 |
| 초대 코드 | Input (text) | 기존 조직 가입 시 필수 |

---

### 2.3 메인 대시보드 (/lead-manager)

#### 2.3.1 전체 레이아웃

```
┌────────────────────────────────────────────────────────────────┐
│ [헤더]                                                         │
│  위마켓 로고   [리드][인벤토리][스케줄]   [도면] [설정] [사용자]   │
├────────────────────────────────────────────────────────────────┤
│ [컨트롤 바]                                                     │
│  날짜: [2025-12-24] ~ [2026-01-12]  지역: [서울][경기]          │
│  API: ● 연결됨   [새로고침] [내보내기] [백업]                     │
├────────────────────────────────────────────────────────────────┤
│ [통계 바] (확장/축소 가능)                                       │
│  ┌────────┐ ┌────────┐ ┌────────┐ ┌────────┐                  │
│  │ 신규    │ │ 제안발송 │ │ 컨택완료 │ │ 계약성사 │                │
│  │  125   │ │   45   │ │   32   │ │   12   │                  │
│  └────────┘ └────────┘ └────────┘ └────────┘                  │
├────────────────────────────────────────────────────────────────┤
│ [필터 영역]                                                     │
│  업종: [전체▼] 세부: [전체▼] 상태: [전체▼] 역: [전체▼]           │
│  뷰: [그리드] [리스트] [지도]                                    │
├────────────────────────────────────────────────────────────────┤
│ [메인 콘텐츠 영역]                                              │
│                                                                │
│  (그리드 뷰 / 리스트 뷰 / 지도 뷰)                               │
│                                                                │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│ [상세 패널] (우측 슬라이드, 리드 선택 시)                         │
│  ┌────────────────────────────────┐                            │
│  │ 사업장명: OOO 병원              │                            │
│  │ [정보] [통화기록] [제안서] [체크리스트]                        │
│  │                                │                            │
│  │ (탭 내용)                       │                            │
│  │                                │                            │
│  └────────────────────────────────┘                            │
└────────────────────────────────────────────────────────────────┘
```

#### 2.3.2 헤더 영역

| 요소 | 동작 |
|------|------|
| 로고 | 클릭 시 / 페이지로 이동 |
| 리드 탭 | 리드 관리 탭 활성화 |
| 인벤토리 탭 | 인벤토리 관리 탭 활성화 |
| 스케줄 탭 | 스케줄 관리 탭 활성화 |
| 도면 버튼 | /floor-plans 페이지로 이동 |
| 설정 버튼 | 설정 모달 열기 |
| 사용자 메뉴 | 드롭다운 (조직명, 역할, 초대코드, 로그아웃) |

#### 2.3.3 컨트롤 바

| 요소 | 타입 | 동작 |
|------|------|------|
| 시작일 | DatePicker | 검색 시작일 설정 (기본: 전월 24일) |
| 종료일 | DatePicker | 검색 종료일 설정 (기본: 오늘) |
| 지역 선택 | MultiSelect | 서울, 경기, 인천 다중 선택 |
| API 상태 | Badge | 연결 상태 표시 (녹색/빨간색) |
| 새로고침 | Button | LocalData API에서 데이터 가져오기 |
| 내보내기 | Button | CSV 다운로드 |
| 백업 | Button | 백업/복원 드롭다운 |

#### 2.3.4 통계 바

| 카드 | 색상 | 표시 내용 |
|------|------|----------|
| 신규 (NEW) | 녹색 계열 (2호선) | 신규 리드 수 |
| 제안발송 (PROPOSAL_SENT) | 하늘색 계열 (4호선) | 제안서 발송 리드 수 |
| 컨택완료 (CONTACTED) | 보라색 계열 (5호선) | 컨택 완료 리드 수 |
| 계약성사 (CONTRACTED) | 주황색 계열 (3호선) | 계약 성사 리드 수 |

#### 2.3.5 필터 영역

| 필터 | 옵션 | 기본값 |
|------|------|--------|
| 업종 | 전체, 건강, 동물, 식품, 문화, 생활, 자원환경, 기타 | 전체 |
| 세부 | 선택된 업종의 세부 항목 | 전체 |
| 상태 | 전체, 신규, 제안발송, 컨택완료, 계약성사 | 전체 |
| 역 | 전체, 역 목록 (데이터 기반) | 전체 |
| 뷰 모드 | 그리드, 리스트, 지도 | 그리드 |

---

### 2.4 그리드 뷰

#### 2.4.1 카드 레이아웃

```
┌────────────────────────────────────────┐
│ [건강] [신규]                   [지도↗] │
│                                        │
│ OOO 의원                               │
│ ─────────────────────────────────      │
│ 📍 서울시 강남구 역삼동 123-45          │
│ 📞 02-1234-5678                        │
│                                        │
│ 🚇 역삼역 (2호선) | 150m                │
│                                        │
│ [상태변경 ▼]                           │
└────────────────────────────────────────┘
```

#### 2.4.2 카드 요소

| 요소 | 설명 |
|------|------|
| 업종 배지 | 업종별 색상 배지 |
| 상태 배지 | 상태별 색상 배지 |
| 지도 버튼 | 해당 리드 위치 지도 뷰 |
| 사업장명 | 굵은 텍스트 |
| 주소 | 도로명 주소 |
| 전화번호 | 클릭 시 전화 걸기 |
| 인근역 정보 | 역명, 노선, 거리 |
| 상태 변경 | 드롭다운으로 상태 변경 |

---

### 2.5 리스트 뷰

#### 2.5.1 테이블 구조

| 컬럼 | 너비 | 정렬 |
|------|------|------|
| 사업장명 | 200px | 좌측 |
| 주소 | 250px | 좌측 |
| 전화번호 | 120px | 좌측 |
| 업종 | 80px | 중앙 |
| 인근역 | 100px | 좌측 |
| 거리 | 80px | 우측 |
| 상태 | 100px | 중앙 |
| 인허가일 | 100px | 중앙 |
| 액션 | 80px | 중앙 |

#### 2.5.2 행 동작

| 동작 | 설명 |
|------|------|
| 행 클릭 | 상세 패널 열기 |
| 상태 클릭 | 상태 변경 드롭다운 |
| 전화번호 클릭 | 전화 걸기 |

---

### 2.6 지도 뷰

#### 2.6.1 화면 구성

```
┌────────────────────────────────────────────────────────────────┐
│ [← 목록으로]                                                    │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│                    (Leaflet 지도)                               │
│                                                                │
│         🔴 🔴                                                   │
│              🟢 🟢 🟢                                            │
│                   🔵 🔵                                         │
│                        🟠                                       │
│                                                                │
│                                                                │
├────────────────────────────────────────────────────────────────┤
│ [범례]                                                         │
│  🟢 신규  🔵 제안발송  🟠 컨택완료  🔴 계약성사                    │
└────────────────────────────────────────────────────────────────┘
```

#### 2.6.2 마커 동작

| 동작 | 설명 |
|------|------|
| 마커 클릭 | 팝업 표시 (사업장명, 주소, 인근역) |
| 팝업 버튼 클릭 | 상세 패널 열기 |
| 클러스터 클릭 | 줌 인 |

#### 2.6.3 마커 색상

| 상태 | 색상 |
|------|------|
| NEW | 녹색 (#00A84D) |
| PROPOSAL_SENT | 하늘색 (#00A5DE) |
| CONTACTED | 보라색 (#996CAC) |
| CONTRACTED | 주황색 (#EF7C1C) |

---

### 2.7 리드 상세 패널

#### 2.7.1 패널 구성

```
┌────────────────────────────────────┐
│ [✕]                    OOO 병원    │
├────────────────────────────────────┤
│ [정보] [통화기록] [제안서] [체크리스트] │
├────────────────────────────────────┤
│                                    │
│ (선택된 탭 내용)                    │
│                                    │
│                                    │
│                                    │
│                                    │
│                                    │
└────────────────────────────────────┘
```

#### 2.7.2 정보 탭

| 필드 | 내용 |
|------|------|
| 사업장명 | OOO 병원 |
| 사업자번호 | 123-45-67890 |
| 주소 | 서울시 강남구 역삼동 123-45 |
| 전화번호 | 02-1234-5678 (클릭 시 전화) |
| 업종 | 건강 > 병원 |
| 인허가일 | 2026-01-10 |
| 인근역 | 역삼역 (2호선) - 150m |
| 상태 | [상태 변경 드롭다운] |
| 담당자 | 홍길동 (2026-01-11 지정) |
| 메모 | [텍스트 영역 - 수정 가능] |

#### 2.7.3 통화기록 탭

```
┌────────────────────────────────────┐
│ [+ 통화 기록 추가]                  │
├────────────────────────────────────┤
│ 2026-01-12 14:30  [관심]           │
│ 담당자: 김대리                      │
│ 메모: 광고에 관심 있음, 견적 요청    │
│ 다음: 견적서 발송 예정              │
├────────────────────────────────────┤
│ 2026-01-10 10:15  [부재중]         │
│ 메모: 전화 연결 안됨                │
│ 다음: 1/12 재통화                  │
├────────────────────────────────────┤
│ ...                                │
└────────────────────────────────────┘
```

#### 2.7.4 제안서 탭

```
┌────────────────────────────────────┐
│ [+ 제안서 작성]                     │
├────────────────────────────────────┤
│ 역삼역 광고 제안서                  │
│ 상태: [발송됨] 2026-01-11          │
│ 금액: 1,500,000원 (10% 할인)       │
│ [보기] [이메일 발송] [PDF]          │
├────────────────────────────────────┤
│ ...                                │
└────────────────────────────────────┘
```

#### 2.7.5 체크리스트 탭

```
┌────────────────────────────────────┐
│ 영업 진행 현황                      │
├────────────────────────────────────┤
│ ✅ 제안서 발송     2026-01-11      │
│    메모: 이메일로 발송 완료          │
├────────────────────────────────────┤
│ ✅ 1차 통화        2026-01-12      │
│    메모: 긍정적 반응                │
├────────────────────────────────────┤
│ ⬜ 미팅 잡힘                        │
│    [완료 처리]                      │
├────────────────────────────────────┤
│ ⬜ 계약 성사                        │
│    [완료 처리]                      │
└────────────────────────────────────┘
```

---

### 2.8 인벤토리 탭

#### 2.8.1 화면 구성

```
┌────────────────────────────────────────────────────────────────┐
│ [필터 영역]                                                     │
│  역명: [전체▼]  광고유형: [전체▼]  상태: [전체▼]                  │
│                                        [Excel 업로드] [+ 추가]  │
├────────────────────────────────────────────────────────────────┤
│ [테이블]                                                        │
│ ┌──────┬────────┬────────┬────────┬────────┬──────┬──────┐    │
│ │ 역명  │ 광고유형 │ 위치코드 │ 월가격  │ 주가격  │ 상태  │ 액션 │    │
│ ├──────┼────────┼────────┼────────┼────────┼──────┼──────┤    │
│ │ 강남  │ 포스터   │ A-01   │ 500,000│ 150,000│ 가용  │ ⋮   │    │
│ │ 역삼  │ 디지털   │ D-03   │ 800,000│ 250,000│ 예약  │ ⋮   │    │
│ │ 삼성  │ 스크린도어│ S-12   │1,200,000│ 400,000│ 사용중│ ⋮   │    │
│ └──────┴────────┴────────┴────────┴────────┴──────┴──────┘    │
├────────────────────────────────────────────────────────────────┤
│ [페이지네이션]  < 1 2 3 4 5 >                                   │
└────────────────────────────────────────────────────────────────┘
```

#### 2.8.2 인벤토리 등록/수정 모달

```
┌────────────────────────────────────┐
│ 광고 인벤토리 등록         [✕]     │
├────────────────────────────────────┤
│ 역명 *         [강남역        ▼]  │
│ 위치 코드 *    [A-01            ]  │
│ 광고 유형 *    [포스터         ▼]  │
│ 광고 크기      [B0 (1030x1456)  ]  │
│ 월간 가격      [500,000       원]  │
│ 주간 가격      [150,000       원]  │
│ 가용 상태 *    [가용          ▼]  │
│ 이용 시작일    [2026-01-15      ]  │
│ 이용 종료일    [2026-12-31      ]  │
│ 일 유동인구    [85,000       명]  │
│ 타겟 인구통계  [20-40대 직장인  ]  │
│ 설명          [                 ]  │
│               [                 ]  │
├────────────────────────────────────┤
│        [취소]        [저장]        │
└────────────────────────────────────┘
```

#### 2.8.3 Excel 업로드 모달

```
┌────────────────────────────────────┐
│ Excel 파일 업로드          [✕]     │
├────────────────────────────────────┤
│                                    │
│  ┌──────────────────────────────┐  │
│  │                              │  │
│  │   📄 파일을 드래그하거나      │  │
│  │      클릭하여 선택           │  │
│  │                              │  │
│  │   지원 형식: .xlsx, .xls     │  │
│  │                              │  │
│  └──────────────────────────────┘  │
│                                    │
│  필드 매핑:                        │
│  - A열: 역명 (필수)                │
│  - B열: 위치코드 (필수)            │
│  - C열: 광고유형 (필수)            │
│  - D열: 월가격                     │
│  - E열: 주가격                     │
│  - F열: 상태                       │
│                                    │
├────────────────────────────────────┤
│ [템플릿 다운로드]        [업로드]   │
└────────────────────────────────────┘
```

---

### 2.9 스케줄 탭

#### 2.9.1 캘린더 뷰

```
┌────────────────────────────────────────────────────────────────┐
│ [뷰 선택]  [캘린더] [업무현황]                    [+ 새 업무]    │
├────────────────────────────────────────────────────────────────┤
│              ◀  2026년 1월  ▶                                  │
├──────┬──────┬──────┬──────┬──────┬──────┬──────┬──────────────┤
│  일  │  월  │  화  │  수  │  목  │  금  │  토  │              │
├──────┼──────┼──────┼──────┼──────┼──────┼──────┤              │
│      │      │      │  1   │  2   │  3   │  4   │              │
├──────┼──────┼──────┼──────┼──────┼──────┼──────┤              │
│  5   │  6   │  7   │  8   │  9   │  10  │  11  │              │
│      │ 📞   │      │ 📅   │      │ 📄   │      │              │
│      │미팅  │      │제안서│      │계약  │      │              │
├──────┼──────┼──────┼──────┼──────┼──────┼──────┤              │
│  12  │  13  │  14  │  15  │  16  │  17  │  18  │              │
│ 📞   │      │      │      │      │      │      │              │
│콜백  │      │      │      │      │      │      │              │
├──────┼──────┼──────┼──────┼──────┼──────┼──────┤              │
│ ...  │      │      │      │      │      │      │              │
└──────┴──────┴──────┴──────┴──────┴──────┴──────┴──────────────┘
```

#### 2.9.2 칸반 보드 (업무현황)

```
┌────────────────────────────────────────────────────────────────┐
│ [뷰 선택]  [캘린더] [업무현황]                    [+ 새 업무]    │
├────────────────────────────────────────────────────────────────┤
│  대기 (3)      │  진행중 (2)    │  완료 (5)     │  취소 (1)    │
├────────────────┼────────────────┼───────────────┼──────────────┤
│ ┌────────────┐ │ ┌────────────┐ │ ┌───────────┐ │ ┌──────────┐ │
│ │ 📞 OOO 콜백 │ │ │ 📅 미팅준비 │ │ │ ✅ 제안서  │ │ │ ❌ 미팅  │ │
│ │ [긴급]      │ │ │ [높음]      │ │ │ 발송완료  │ │ │ 취소됨   │ │
│ │ 1/12       │ │ │ 1/13       │ │ │ 1/10     │ │ │ 1/8     │ │
│ └────────────┘ │ └────────────┘ │ └───────────┘ │ └──────────┘ │
│ ┌────────────┐ │ ┌────────────┐ │ ┌───────────┐ │              │
│ │ 📄 견적작성 │ │ │ 📞 후속전화 │ │ │ ✅ 계약   │ │              │
│ │ [보통]      │ │ │ [보통]      │ │ │ 체결완료  │ │              │
│ │ 1/14       │ │ │ 1/15       │ │ │ 1/9      │ │              │
│ └────────────┘ │ └────────────┘ │ └───────────┘ │              │
│ ...           │                │ ...          │              │
└────────────────┴────────────────┴───────────────┴──────────────┘
```

#### 2.9.3 업무 생성/수정 모달

```
┌────────────────────────────────────┐
│ 새 업무 등록               [✕]     │
├────────────────────────────────────┤
│ 제목 *        [                 ]  │
│ 업무 유형 *   [전화           ▼]  │
│               (전화/미팅/제안서/   │
│                후속/계약/기타)     │
│ 설명          [                 ]  │
│               [                 ]  │
│ 예정일 *      [2026-01-15      ]  │
│ 예정 시간     [14:00           ]  │
│ 우선순위 *    [보통           ▼]  │
│               (낮음/보통/높음/긴급)│
│ 담당자        [홍길동          ]  │
│ 연결 리드     [OOO 병원       ▼]  │
│ 알림 시간     [30분 전        ▼]  │
│ 메모          [                 ]  │
├────────────────────────────────────┤
│        [취소]        [저장]        │
└────────────────────────────────────┘
```

---

### 2.10 역사 도면 페이지 (/floor-plans)

#### 2.10.1 화면 구성

```
┌────────────────────────────────────────────────────────────────┐
│ [헤더]                                                         │
│  ← 대시보드    역사 도면 관리                                    │
├────────────────────────────────────────────────────────────────┤
│ [노선 탭]                                                       │
│  [1호선 (23)] [2호선 (45)] [5호선 (38)] [7호선 (42)] [8호선 (15)]│
├─────────────────────┬──────────────────────────────────────────┤
│ [역 목록]            │ [도면 뷰어]                               │
│                     │                                          │
│ 🔍 역 검색           │  역삼역 - 역구내도면                       │
│ ──────────────      │  ┌────────────────────────────────────┐  │
│                     │  │                                    │  │
│ ○ 강남역 (2)        │  │         (도면 이미지)                │  │
│ ● 역삼역 (3)        │  │                                    │  │
│ ○ 삼성역 (2)        │  │    🔴 A-01                         │  │
│ ○ 선릉역 (2)        │  │         🔴 A-02                    │  │
│ ○ 역삼역 (2)        │  │              🔴 D-01               │  │
│ ○ 강변역 (1)        │  │                                    │  │
│ ...                 │  │                                    │  │
│                     │  └────────────────────────────────────┘  │
│                     │                                          │
│                     │  [다운로드] [확대] [축소]                  │
│                     │                                          │
├─────────────────────┼──────────────────────────────────────────┤
│ [일괄 다운로드]       │ [도면 업로드]                             │
└─────────────────────┴──────────────────────────────────────────┘
```

#### 2.10.2 노선 탭

| 노선 | 색상 | 표시 |
|------|------|------|
| 1호선 | #0052A4 | 도면 수 표시 |
| 2호선 | #00A84D | 도면 수 표시 |
| 5호선 | #996CAC | 도면 수 표시 |
| 7호선 | #747F00 | 도면 수 표시 |
| 8호선 | #E6186C | 도면 수 표시 |

#### 2.10.3 도면 뷰어 기능

| 기능 | 설명 |
|------|------|
| 줌 인/아웃 | 마우스 휠 또는 버튼 |
| 드래그 | 도면 이동 |
| 마커 클릭 | 광고 위치 정보 팝업 |
| 다운로드 | 현재 도면 다운로드 |

---

### 2.11 설정 모달

```
┌────────────────────────────────────┐
│ 설정                       [✕]     │
├────────────────────────────────────┤
│ [API 설정]                         │
│                                    │
│ LocalData API 키                   │
│ [••••••••••••••••••••••••]        │
│                                    │
│ CORS 프록시 URL                    │
│ [https://proxy.example.com   ]    │
│                                    │
│ [검색 설정]                         │
│                                    │
│ 검색 기준                           │
│ ○ 인허가일 기준                     │
│ ● 수정일 기준                       │
│                                    │
│ 기본 지역                           │
│ ☑ 서울특별시                        │
│ ☑ 경기도                            │
│ ☐ 인천광역시                        │
│                                    │
├────────────────────────────────────┤
│        [취소]        [저장]        │
└────────────────────────────────────┘
```

---

### 2.12 통화 기록 모달

```
┌────────────────────────────────────┐
│ 통화 기록 추가             [✕]     │
├────────────────────────────────────┤
│ 리드: OOO 병원                     │
├────────────────────────────────────┤
│ 통화 일시 *   [2026-01-12 14:30]  │
│ 통화 시간     [5         ] 분     │
│ 통화 결과 *   [관심          ▼]  │
│               (부재중/거절/관심/   │
│                콜백요청/미팅잡힘/기타)│
│ 담당자        [김대리          ]  │
│ 메모          [                 ]  │
│               [광고에 관심 있음,  ]  │
│               [견적 요청          ]  │
│ 다음 조치     [견적서 발송 예정  ]  │
│ 콜백 요청일   [2026-01-15      ]  │
├────────────────────────────────────┤
│        [취소]        [저장]        │
└────────────────────────────────────┘
```

---

### 2.13 제안서 작성 모달

```
┌────────────────────────────────────┐
│ 제안서 작성               [✕]      │
├────────────────────────────────────┤
│ 리드: OOO 병원                     │
│ 인근역: 역삼역 (2호선)              │
├────────────────────────────────────┤
│ 제목 *       [역삼역 광고 제안서 ]  │
│                                    │
│ 인사말                             │
│ [안녕하세요, OOO 병원 담당자님.   ]  │
│ [역삼역 인근 광고 상품을 제안     ]  │
│ [드립니다.                        ]  │
│                                    │
│ 광고 상품 선택 *                    │
│ ☑ 역삼역 A-01 포스터 (500,000원)   │
│ ☑ 역삼역 D-03 디지털 (800,000원)   │
│ ☐ 역삼역 S-05 스크린도어           │
│                                    │
│ 합계: 1,300,000원                  │
│                                    │
│ 할인율       [10         ] %      │
│ 최종 금액: 1,170,000원             │
│                                    │
├────────────────────────────────────┤
│ [취소]    [저장]    [이메일 발송]   │
└────────────────────────────────────┘
```

---

## 3. 기능 상세 명세

### 3.1 리드 수집 기능

#### 3.1.1 기능 ID: FN-LEAD-001

**기능명:** 리드 자동 수집

**설명:** LocalData.go.kr API에서 사업자 인허가 데이터를 자동으로 수집하여 리드로 저장한다.

**트리거:** 새로고침 버튼 클릭

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| 시작일 | Date | Y | 검색 시작일 (기본: 전월 24일) |
| 종료일 | Date | Y | 검색 종료일 (기본: 오늘) |
| 지역 코드 | String[] | Y | 선택된 지역 코드 목록 |
| 업종 | String | N | 선택된 업종 카테고리 |
| 세부 업종 | String[] | N | 선택된 세부 업종 서비스 ID |

**처리 로직:**

```
1. 선택된 지역 코드 목록 확인
2. 선택된 업종에 따른 서비스 ID 목록 생성
   - 업종 미선택 시: 모든 서비스 ID
   - 업종 선택 시: 해당 업종의 서비스 ID만
3. 각 (지역코드, 서비스ID) 조합에 대해:
   a. /api/localdata API 호출
   b. 응답 데이터 파싱
   c. 200ms 대기 (Rate Limiting 방지)
4. 수집된 데이터에 대해:
   a. 좌표 변환 (GRS80 → WGS84)
   b. 최인접 역 계산 (Haversine 공식)
   c. 중복 체크 (사업장명 + 도로명주소)
5. 신규 데이터만 배치 저장 (50건씩)
6. 결과 반환 (신규 N건, 중복 M건)
```

**출력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| success | Boolean | 성공 여부 |
| newCount | Number | 신규 저장 건수 |
| skippedCount | Number | 중복 스킵 건수 |
| message | String | 결과 메시지 |

**예외 처리:**
| 상황 | 처리 |
|------|------|
| API 키 미설정 | 설정 모달 안내 |
| API 호출 실패 | 에러 메시지 표시, 재시도 버튼 |
| 좌표 변환 실패 | 해당 데이터 스킵, 로그 기록 |

---

#### 3.1.2 기능 ID: FN-LEAD-002

**기능명:** 좌표 변환

**설명:** 원본 GRS80 좌표를 WGS84 좌표로 변환한다.

**입력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| coordX | Number | 원본 X 좌표 |
| coordY | Number | 원본 Y 좌표 |

**처리 로직:**

```javascript
// proj4 라이브러리 사용
const srcProj = '+proj=tmerc +lat_0=38 +lon_0=127 +k=1 +x_0=200000 +y_0=500000 +ellps=GRS80';
const dstProj = '+proj=longlat +ellps=WGS84 +datum=WGS84';

const [longitude, latitude] = proj4(srcProj, dstProj, [coordX, coordY]);
```

**출력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| latitude | Number | 위도 |
| longitude | Number | 경도 |

---

#### 3.1.3 기능 ID: FN-LEAD-003

**기능명:** 최인접 역 계산

**설명:** 주어진 좌표에서 가장 가까운 지하철역을 찾는다.

**입력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| latitude | Number | 위도 |
| longitude | Number | 경도 |

**처리 로직:**

```javascript
// Haversine 공식
function haversineDistance(lat1, lng1, lat2, lng2) {
  const R = 6371000; // 지구 반지름 (미터)
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLng = (lng2 - lng1) * Math.PI / 180;

  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1 * Math.PI/180) *
            Math.cos(lat2 * Math.PI/180) *
            Math.sin(dLng/2)**2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

// 모든 역과의 거리 계산 후 최소값 찾기
let nearestStation = null;
let minDistance = Infinity;

for (const station of SUBWAY_STATIONS) {
  const distance = haversineDistance(latitude, longitude, station.lat, station.lng);
  if (distance < minDistance) {
    minDistance = distance;
    nearestStation = station;
  }
}
```

**출력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| nearestStation | String | 역명 |
| stationDistance | Number | 거리 (미터) |
| stationLines | String[] | 노선 목록 |

---

### 3.2 리드 상태 관리

#### 3.2.1 기능 ID: FN-LEAD-004

**기능명:** 리드 상태 변경

**설명:** 리드의 영업 상태를 변경한다.

**트리거:** 상태 드롭다운에서 상태 선택

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| leadId | UUID | Y | 리드 ID |
| status | Enum | Y | 새 상태 |

**상태 전이 규칙:**

```
NEW → PROPOSAL_SENT (제안서 발송 시 자동)
NEW → CONTACTED (상태 직접 변경 가능)
PROPOSAL_SENT → CONTACTED (통화 성공 시 자동)
CONTACTED → CONTRACTED (계약 체결 시)

역방향 전이도 허용 (관리자 권한)
```

**처리 로직:**

```
1. 현재 리드 상태 확인
2. 상태 업데이트
3. CONTACTED 변경 시:
   a. 현재 사용자를 담당자로 자동 지정
   b. 지정 시간 기록
4. 상태 변경 이력 저장 (선택)
5. UI 업데이트
```

**출력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| success | Boolean | 성공 여부 |
| message | String | 결과 메시지 |
| assignedToName | String | 담당자명 (CONTACTED 시) |

---

### 3.3 통화 기록 관리

#### 3.3.1 기능 ID: FN-CRM-001

**기능명:** 통화 기록 등록

**설명:** 고객과의 통화 내용을 기록한다.

**트리거:** 통화 기록 추가 버튼 클릭 후 저장

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| leadId | UUID | Y | 리드 ID |
| calledAt | DateTime | Y | 통화 일시 |
| durationSeconds | Number | N | 통화 시간 (초) |
| outcome | Enum | Y | 통화 결과 |
| contactPerson | String | N | 담당자명 |
| notes | String | N | 메모 |
| nextAction | String | N | 다음 조치 |
| nextContactDate | Date | N | 콜백 요청일 |

**처리 로직:**

```
1. 입력값 검증
2. 통화 기록 저장
3. 통화 결과에 따른 자동 처리:
   - INTERESTED, MEETING_SCHEDULED:
     a. 리드 상태를 CONTACTED로 변경
     b. 담당자 자동 지정
   - CALLBACK_REQUESTED:
     a. 콜백 요청일을 캘린더 이벤트로 등록
4. 리드 상세 패널 업데이트
```

**통화 결과별 처리:**

| 결과 | 리드 상태 변경 | 추가 동작 |
|------|---------------|----------|
| NO_ANSWER | 유지 | - |
| REJECTED | 유지 | - |
| INTERESTED | CONTACTED | 담당자 지정 |
| CALLBACK_REQUESTED | 유지 | 캘린더 이벤트 생성 |
| MEETING_SCHEDULED | CONTACTED | 담당자 지정, 미팅 업무 생성 |
| OTHER | 유지 | - |

---

### 3.4 제안서 관리

#### 3.4.1 기능 ID: FN-PROP-001

**기능명:** 제안서 작성

**설명:** 리드에 대한 광고 제안서를 작성한다.

**트리거:** 제안서 작성 버튼 클릭 후 저장

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| leadId | UUID | Y | 리드 ID |
| title | String | Y | 제안서 제목 |
| greetingMessage | String | N | 인사말 |
| inventoryIds | UUID[] | Y | 선택된 인벤토리 ID 목록 |
| discountRate | Number | N | 할인율 (%) |

**처리 로직:**

```
1. 입력값 검증
2. 선택된 인벤토리 정보 조회
3. 가격 계산:
   - totalPrice = sum(각 인벤토리 월간 가격)
   - finalPrice = totalPrice * (1 - discountRate/100)
4. 제안서 저장 (상태: DRAFT)
5. 효과 분석 데이터 생성:
   - dailyImpressions: 선택된 역들의 일 유동인구 합
   - monthlyReach: dailyImpressions * 30
   - targetDemographics: 인벤토리 타겟 정보 취합
```

**출력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| success | Boolean | 성공 여부 |
| proposalId | UUID | 생성된 제안서 ID |

---

#### 3.4.2 기능 ID: FN-PROP-002

**기능명:** 제안서 이메일 발송

**설명:** 작성된 제안서를 이메일로 발송한다.

**트리거:** 이메일 발송 버튼 클릭

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| proposalId | UUID | Y | 제안서 ID |
| recipientEmail | String | Y | 수신자 이메일 |
| recipientName | String | N | 수신자명 |

**처리 로직:**

```
1. 제안서 정보 조회
2. 리드 정보 조회 (사업장명, 인근역)
3. 인벤토리 정보 조회
4. HTML 이메일 템플릿 생성:
   - 헤더: 위마켓 로고, 제목
   - 인사말
   - 역 정보 (노선 배지 포함)
   - 광고 상품 테이블
   - 가격 정보 (합계, 할인, 최종)
   - 예상 효과
   - CTA 버튼
   - 푸터
5. /api/send-proposal 호출 (Resend API)
6. 성공 시:
   - 제안서 상태: SENT
   - 발송 시간 기록
   - 리드 상태: PROPOSAL_SENT
```

**이메일 템플릿 구조:**

```html
<!DOCTYPE html>
<html>
<head>
  <style>
    /* 인라인 스타일 */
    .line-badge { /* 노선별 색상 */ }
    .price-table { /* 가격 테이블 */ }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="위마켓" />
    <h1>{제안서 제목}</h1>
  </header>

  <section class="greeting">
    {인사말}
  </section>

  <section class="station-info">
    <span class="line-badge" style="background: {노선색상}">{노선}</span>
    {역명}
  </section>

  <section class="products">
    <table class="price-table">
      <tr><th>상품</th><th>위치</th><th>가격</th></tr>
      {인벤토리 목록}
    </table>
    <p>합계: {totalPrice}원</p>
    <p>할인: {discountRate}%</p>
    <p><strong>최종: {finalPrice}원</strong></p>
  </section>

  <section class="effect">
    <h3>예상 효과</h3>
    <p>일 노출: {dailyImpressions}회</p>
    <p>월 도달: {monthlyReach}명</p>
  </section>

  <footer>
    위마켓 | 서울 지하철 광고
  </footer>
</body>
</html>
```

---

### 3.5 업무 관리

#### 3.5.1 기능 ID: FN-TASK-001

**기능명:** 업무 생성

**설명:** 새로운 업무를 생성한다.

**트리거:** 새 업무 버튼 클릭 또는 캘린더 날짜 클릭 후 저장

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| title | String | Y | 업무 제목 |
| taskType | Enum | Y | 업무 유형 |
| description | String | N | 상세 설명 |
| dueDate | Date | Y | 예정일 |
| dueTime | Time | N | 예정 시간 |
| priority | Enum | Y | 우선순위 |
| assignee | String | N | 담당자 |
| leadId | UUID | N | 연결 리드 ID |
| reminderAt | DateTime | N | 알림 시간 |

**처리 로직:**

```
1. 입력값 검증
2. 업무 저장 (상태: PENDING)
3. 연결 리드가 있으면 리드 정보 함께 저장
4. 알림 시간이 설정되면 알림 스케줄 등록
5. 캘린더/칸반 보드 업데이트
```

---

#### 3.5.2 기능 ID: FN-TASK-002

**기능명:** 업무 상태 변경 (드래그 & 드롭)

**설명:** 칸반 보드에서 드래그 & 드롭으로 업무 상태를 변경한다.

**트리거:** 칸반 카드를 다른 컬럼으로 드래그

**처리 로직:**

```
1. 드래그 시작: 카드 선택, 시각적 피드백
2. 드래그 중: 드롭 가능 영역 하이라이트
3. 드롭:
   a. 새 상태로 업데이트
   b. COMPLETED 컬럼 드롭 시 completedAt 기록
4. UI 업데이트 (애니메이션)
```

---

### 3.6 도면 관리

#### 3.6.1 기능 ID: FN-FLOOR-001

**기능명:** 도면 조회

**설명:** 노선별/역별 역사 도면을 조회한다.

**트리거:** 노선 탭 클릭 → 역 선택

**처리 로직:**

```
1. 노선 탭 클릭 시:
   a. 해당 노선의 역 목록 조회
   b. 역별 도면 수 표시
2. 역 선택 시:
   a. 해당 역의 도면 목록 조회
   b. 첫 번째 도면 뷰어에 표시
3. 도면 유형 선택 시:
   a. 해당 유형 도면으로 전환
```

---

#### 3.6.2 기능 ID: FN-FLOOR-002

**기능명:** 도면 업로드

**설명:** 새로운 도면을 업로드한다.

**트리거:** 도면 업로드 버튼 클릭 후 파일 선택

**입력:**
| 항목 | 타입 | 필수 | 설명 |
|------|------|------|------|
| lineNumber | String | Y | 노선 번호 |
| planType | String | Y | 도면 유형 |
| files | File[] | Y | 이미지 파일 목록 |

**처리 로직:**

```
1. 파일 검증 (형식: JPG, PNG / 크기 제한)
2. 파일명에서 역명 자동 추출
   - 패턴: "01_역삼-1.JPG" → "역삼"
3. Supabase Storage에 업로드
   - 경로: floor-plans/{노선}_{도면유형}/{파일명}
4. 메타데이터 저장:
   - 역명, 노선, 도면유형, Storage 경로, 파일크기
5. 목록 업데이트
```

---

#### 3.6.3 기능 ID: FN-FLOOR-003

**기능명:** 도면 일괄 다운로드

**설명:** 선택한 도면들을 ZIP 파일로 다운로드한다.

**트리거:** 일괄 다운로드 모달에서 선택 후 다운로드

**입력:**
| 항목 | 타입 | 설명 |
|------|------|------|
| floorPlanIds | UUID[] | 선택된 도면 ID 목록 |

**처리 로직:**

```
1. 선택된 도면 정보 조회
2. 각 도면 이미지 다운로드 (Supabase Storage)
3. JSZip으로 ZIP 파일 생성
   - 폴더 구조: {노선}/{역명}/{파일명}
4. ZIP 파일 브라우저로 다운로드
5. 진행 상황 표시 (X/N 완료)
```

---

## 4. API 명세

### 4.1 /api/localdata (POST)

**설명:** LocalData.go.kr API를 서버사이드에서 호출

**요청:**
```json
{
  "serviceId": "01_01_02_P",
  "regionCode": "6110000",
  "startDate": "20260101",
  "endDate": "20260112",
  "pageIndex": 1,
  "pageSize": 100
}
```

**응답:**
```json
{
  "success": true,
  "data": [
    {
      "bizName": "OOO 병원",
      "bizId": "123-45-67890",
      "roadAddress": "서울시 강남구 역삼동 123-45",
      "lotAddress": "서울시 강남구 역삼동 123",
      "coordX": 200000,
      "coordY": 500000,
      "phone": "02-1234-5678",
      "licenseDate": "2026-01-10"
    }
  ],
  "totalCount": 150,
  "pageIndex": 1,
  "pageSize": 100
}
```

**에러 응답:**
```json
{
  "success": false,
  "error": "API 호출 실패",
  "code": "API_ERROR"
}
```

---

### 4.2 /api/send-proposal (POST)

**설명:** Resend API를 통해 제안서 이메일 발송

**요청:**
```json
{
  "leadId": "uuid",
  "recipientEmail": "customer@example.com",
  "recipientName": "홍길동",
  "stationName": "역삼역",
  "stationLines": ["2"],
  "inventoryItems": [
    {
      "id": "uuid",
      "stationName": "역삼역",
      "adType": "포스터",
      "locationCode": "A-01",
      "priceMonthly": 500000
    }
  ],
  "totalPrice": 1300000,
  "discountRate": 10,
  "finalPrice": 1170000,
  "greetingMessage": "안녕하세요..."
}
```

**응답:**
```json
{
  "success": true,
  "messageId": "resend-message-id"
}
```

---

### 4.3 /api/station-info (POST)

**설명:** KRIC API를 통해 역 편의시설 정보 조회

**요청:**
```json
{
  "stationName": "역삼"
}
```

**응답:**
```json
{
  "success": true,
  "data": {
    "stationName": "역삼",
    "facilities": [
      { "type": "편의점", "name": "CU", "location": "B1" },
      { "type": "카페", "name": "스타벅스", "location": "1F" }
    ]
  }
}
```

---

### 4.4 /api/ai-proposal (POST)

**설명:** AI 기반 맞춤형 광고 제안 생성

**요청:**
```json
{
  "name": "홍길동",
  "company": "OOO 병원",
  "phone": "02-1234-5678",
  "email": "hong@example.com",
  "address": "서울시 강남구 역삼동",
  "businessType": "병원",
  "adType": "포스터",
  "budget": "100만원 이하",
  "message": "역삼역 근처 광고 문의"
}
```

**응답:**
```json
{
  "success": true,
  "proposal": {
    "recommendedStations": [
      {
        "name": "역삼역",
        "lines": ["2"],
        "dailyTraffic": 85000,
        "reason": "사업장에서 150m 거리, 직장인 유동인구 많음"
      }
    ],
    "recommendedAdTypes": [
      {
        "type": "포스터",
        "reason": "예산 대비 높은 노출 효과"
      }
    ],
    "budgetPlan": {
      "items": [
        { "station": "역삼역", "adType": "포스터", "price": 500000 }
      ],
      "total": 500000
    }
  }
}
```

---

### 4.5 /api/backup (POST)

**설명:** 데이터 백업 및 복원

**백업 요청:**
```json
{
  "action": "backup"
}
```

**백업 응답:**
```json
{
  "success": true,
  "data": {
    "leads": [...],
    "exportedAt": "2026-01-12T10:00:00Z",
    "count": 150
  }
}
```

**복원 요청:**
```json
{
  "action": "restore",
  "data": {
    "leads": [...]
  }
}
```

---

### 4.6 /api/floor-plans/upload (POST)

**설명:** 도면 이미지 업로드

**요청:** multipart/form-data
- file: 이미지 파일
- lineNumber: 노선 번호
- planType: 도면 유형
- stationName: 역명

**응답:**
```json
{
  "success": true,
  "floorPlan": {
    "id": "uuid",
    "imageUrl": "https://storage.supabase.co/...",
    "storagePath": "floor-plans/2호선_역구내도면/01_역삼-1.JPG"
  }
}
```

---

### 4.7 /api/floor-plans/download (GET)

**설명:** 도면 이미지 다운로드

**요청:**
```
GET /api/floor-plans/download?ids=uuid1,uuid2,uuid3&format=zip
```

**응답:** ZIP 파일 스트림

---

## 5. 데이터 흐름

### 5.1 리드 수집 데이터 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  클라이언트   │     │  Next.js    │     │ LocalData   │
│  (브라우저)  │     │   서버      │     │   API       │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │ 1. 새로고침 클릭   │                   │
       │──────────────────>│                   │
       │                   │ 2. API 호출       │
       │                   │──────────────────>│
       │                   │                   │
       │                   │ 3. XML 응답       │
       │                   │<──────────────────│
       │                   │                   │
       │                   │ 4. JSON 변환      │
       │ 5. 리드 데이터     │                   │
       │<──────────────────│                   │
       │                   │                   │
       │ 6. 좌표 변환 (proj4)                   │
       │ 7. 역 매칭 (Haversine)                │
       │                   │                   │
       │ 8. 저장 요청      │                   │
       │──────────────────>│                   │
       │                   │                   │
       │                   │     ┌─────────────┐
       │                   │     │  Supabase   │
       │                   │     └──────┬──────┘
       │                   │ 9. INSERT  │
       │                   │───────────>│
       │                   │            │
       │                   │ 10. 결과   │
       │                   │<───────────│
       │ 11. 완료 메시지   │            │
       │<──────────────────│            │
       │                   │            │
```

### 5.2 제안서 발송 데이터 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  클라이언트   │     │  Next.js    │     │   Resend    │
│  (브라우저)  │     │   서버      │     │    API      │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │ 1. 이메일 발송    │                   │
       │──────────────────>│                   │
       │                   │                   │
       │                   │ 2. 제안서 조회    │
       │                   │     ┌─────────────┐
       │                   │     │  Supabase   │
       │                   │     └──────┬──────┘
       │                   │<───────────│
       │                   │            │
       │                   │ 3. HTML 생성│
       │                   │            │
       │                   │ 4. 이메일 발송
       │                   │──────────────────>│
       │                   │                   │
       │                   │ 5. 발송 결과      │
       │                   │<──────────────────│
       │                   │                   │
       │                   │ 6. 상태 업데이트  │
       │                   │───────────>│
       │                   │            │
       │ 7. 완료           │            │
       │<──────────────────│            │
```

### 5.3 인증 데이터 흐름

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  클라이언트   │     │ Middleware  │     │  Supabase   │
│  (브라우저)  │     │             │     │    Auth     │
└──────┬──────┘     └──────┬──────┘     └──────┬──────┘
       │                   │                   │
       │ 1. 페이지 요청    │                   │
       │──────────────────>│                   │
       │                   │ 2. 세션 확인      │
       │                   │──────────────────>│
       │                   │                   │
       │                   │ 3. 세션 정보      │
       │                   │<──────────────────│
       │                   │                   │
       │                   │ 4. 보호 라우트?   │
       │                   │                   │
       │ [인증됨]          │                   │
       │<─ 페이지 렌더링 ──│                   │
       │                   │                   │
       │ [미인증]          │                   │
       │<─ /auth 리다이렉트│                   │
```

---

## 6. 비즈니스 규칙

### 6.1 리드 관리 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-LEAD-001 | 리드는 사업장명 + 도로명주소 조합으로 중복 체크한다 |
| BR-LEAD-002 | CONTACTED 상태 변경 시 현재 사용자가 담당자로 자동 지정된다 |
| BR-LEAD-003 | 리드 상태는 어느 방향으로든 변경 가능하다 |
| BR-LEAD-004 | 삭제된 리드는 복구할 수 없다 |

### 6.2 제안서 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-PROP-001 | 제안서 발송 시 리드 상태가 자동으로 PROPOSAL_SENT로 변경된다 |
| BR-PROP-002 | 할인율은 0~100% 범위만 허용된다 |
| BR-PROP-003 | 최소 1개 이상의 인벤토리를 선택해야 한다 |
| BR-PROP-004 | 이메일 발송 후 제안서 수정 시 새 버전으로 관리된다 |

### 6.3 통화 기록 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-CRM-001 | INTERESTED/MEETING_SCHEDULED 결과 시 리드 상태가 CONTACTED로 변경된다 |
| BR-CRM-002 | CALLBACK_REQUESTED 시 콜백 요청일이 필수이다 |
| BR-CRM-003 | 콜백 요청일은 캘린더에 자동 등록된다 |

### 6.4 업무 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-TASK-001 | COMPLETED 상태로 변경 시 완료 시간이 자동 기록된다 |
| BR-TASK-002 | 알림 시간은 예정일 이전만 설정 가능하다 |
| BR-TASK-003 | 연결된 리드가 삭제되어도 업무는 유지된다 |

### 6.5 조직 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-ORG-001 | 사용자는 반드시 하나 이상의 조직에 소속되어야 한다 |
| BR-ORG-002 | 조직 owner는 삭제할 수 없다 |
| BR-ORG-003 | 초대 코드는 조직당 하나만 존재한다 |
| BR-ORG-004 | owner만 멤버 역할을 변경할 수 있다 |

### 6.6 데이터 접근 규칙

| 규칙 ID | 설명 |
|---------|------|
| BR-DATA-001 | 사용자는 자신이 속한 조직의 데이터만 접근 가능하다 |
| BR-DATA-002 | RLS 정책이 모든 테이블에 적용된다 |
| BR-DATA-003 | API 키는 서버사이드에서만 사용된다 |

---

## 문서 이력

| 버전 | 날짜 | 작성자 | 변경 내용 |
|------|------|--------|----------|
| 1.0 | 2026-01-12 | Claude | 최초 작성 |
